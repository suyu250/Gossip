<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Gossip</title>
  <link rel="stylesheet" href="/css/common.css">
  <style>
    body {
      background: 
        radial-gradient(circle at 10% 20%, rgba(213,210,212,0.96) 0%, rgba(213,210,212,0.75) 20%, rgba(213,210,212,0) 45%),
        radial-gradient(circle at 85% 10%, rgba(210,196,224,0.9) 0%, rgba(210,196,224,0.55) 30%, rgba(210,196,224,0) 58%),
        radial-gradient(circle at 80% 90%, rgba(205,225,246,0.98) 0%, rgba(205,225,246,0.75) 36%, rgba(205,225,246,0) 60%),
        radial-gradient(circle at 30% 80%, rgba(141,139,141,0.9) 0%, rgba(91,92,94,0.06) 60%, rgba(255,255,255,0) 100%),
        linear-gradient(180deg, rgba(141,139,141,0.04) 0%, rgba(255,255,255,0.01) 100%);
      background-attachment: fixed;
      font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    .dashboard-container {
      min-height: 100vh;
      padding: 0;
    }

    .dashboard-header {
      background: rgba(229, 228, 233, 0.85);
      backdrop-filter: blur(12px);
      padding: 24px 48px;
      border-bottom: 1px solid rgba(141, 139, 141, 0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(141, 139, 141, 0.08);
    }

    .dashboard-title {
      font-size: 24pt;
      font-weight: 600;
      color: #8d8b8d;
      letter-spacing: -1px;
    }

    .dashboard-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-info {
      font-size: 12pt;
      color: #8d8b8d;
      font-weight: normal;
    }

    .user-info strong {
      color: #5b5c5e;
      font-weight: 600;
    }

    .header-btn {
      padding: 12px 28px;
      border: none;
      background: rgba(229, 228, 233, 0.9);
      color: #8d8b8d;
      font-size: 11pt;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 24px;
      box-shadow: 0 2px 12px rgba(141, 139, 141, 0.12);
    }

    .change-password-btn {
      background: rgba(229, 228, 233, 0.9);
    }

    .change-password-btn:hover {
      background: rgba(220, 220, 221, 0.95);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(141, 139, 141, 0.18);
    }

    .logout-btn {
      background: rgba(141, 139, 141, 0.2);
      color: #8d8b8d;
    }

    .logout-btn:hover {
      background: rgba(141, 139, 141, 0.35);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(141, 139, 141, 0.25);
    }

    .dashboard-content {
      padding: 40px;
      max-width: 1600px;
      margin: 0 auto;
    }

    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: rgba(229, 228, 233, 0.75);
      backdrop-filter: blur(10px);
      padding: 32px;
      border-radius: 16px;
      border: none;
      text-align: center;
      transition: all 0.4s ease;
      box-shadow: 0 4px 20px rgba(141, 139, 141, 0.1);
    }

    .stat-card:hover {
      background: rgba(229, 228, 233, 0.95);
      transform: translateY(-6px);
      box-shadow: 0 8px 30px rgba(141, 139, 141, 0.18);
    }

    .stat-value {
      font-size: 48pt;
      font-weight: 600;
      color: #8d8b8d;
      margin-bottom: 12px;
      animation: statFloat 3s ease-in-out infinite;
    }

    @keyframes statFloat {
      0%, 100% {
        transform: translateY(0);
        opacity: 0.85;
      }
      50% {
        transform: translateY(-4px);
        opacity: 1;
      }
    }

    .stat-card:hover .stat-value {
      color: #5b5c5e;
    }

    .stat-label {
      font-size: 11pt;
      color: rgba(141, 139, 141, 0.7);
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .stat-card:hover .stat-label {
      color: #8d8b8d;
    }

    .groups-section {
      background: rgba(229, 228, 233, 0.6);
      backdrop-filter: blur(12px);
      padding: 40px;
      border-radius: 20px;
      border: none;
      box-shadow: 0 6px 30px rgba(141, 139, 141, 0.12);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(141, 139, 141, 0.15);
    }

    .section-title {
      font-size: 18pt;
      font-weight: 600;
      color: #8d8b8d;
      letter-spacing: -0.5px;
    }

    .refresh-btn {
      padding: 10px 24px;
      background: rgba(229, 228, 233, 0.9);
      border: none;
      border-radius: 20px;
      font-size: 11pt;
      color: #8d8b8d;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 12px rgba(141, 139, 141, 0.1);
    }

    .refresh-btn:hover {
      background: rgba(220, 220, 221, 0.95);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(141, 139, 141, 0.18);
    }

    .group-item {
      border: none;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(8px);
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 2px 12px rgba(141, 139, 141, 0.08);
    }

    .group-item:hover {
      background: rgba(255, 255, 255, 0.7);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(141, 139, 141, 0.12);
    }

    .group-item-header {
      background: transparent;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      border-bottom: 1px solid rgba(141, 139, 141, 0.08);
    }

    .group-item-header:hover {
      background: rgba(229, 228, 233, 0.3);
    }

    .group-item-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .group-number {
      font-size: 14pt;
      font-weight: 600;
      color: #8d8b8d;
      letter-spacing: 0px;
    }

    .group-badge {
      padding: 6px 14px;
      border: none;
      border-radius: 12px;
      font-size: 9pt;
      font-weight: 500;
      background: rgba(229, 228, 233, 0.8);
      color: #8d8b8d;
      letter-spacing: 0.5px;
    }

    .group-badge.complete {
      background: rgba(141, 139, 141, 0.25);
      color: #5b5c5e;
    }

    .group-badge.incomplete {
      background: rgba(229, 228, 233, 0.8);
      color: rgba(141, 139, 141, 0.7);
    }

    .group-item-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .delete-group-btn {
      padding: 6px 16px;
      background: rgba(229, 228, 233, 0.8);
      color: #8d8b8d;
      border: none;
      border-radius: 10px;
      font-size: 9pt;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.3px;
    }

    .delete-group-btn:hover {
      background: rgba(141, 139, 141, 0.25);
      color: #5b5c5e;
      transform: scale(1.05);
    }

    .expand-icon {
      transition: transform 0.2s ease;
    }

    .expand-icon.expanded {
      transform: rotate(180deg);
    }

    .group-item-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .group-item-body.expanded {
      max-height: 2000px;
    }

    .entries-table {
      width: 100%;
      border-collapse: collapse;
    }

    .entries-table th {
      background: rgba(229, 228, 233, 0.4);
      padding: 12px 16px;
      text-align: left;
      font-size: 10pt;
      font-weight: 600;
      color: #8d8b8d;
      border-bottom: 1px solid rgba(141, 139, 141, 0.1);
      letter-spacing: 0.3px;
    }

    .entries-table td {
      padding: 12px 16px;
      font-size: 11pt;
      color: #8d8b8d;
      border-bottom: 1px solid rgba(141, 139, 141, 0.06);
    }

    .entries-table tr:hover {
      background: rgba(229, 228, 233, 0.3);
    }

    .entry-text {
      max-width: 400px;
      word-break: break-word;
    }

    .entry-solfege {
      font-family: "Courier New", monospace;
      color: rgba(141, 139, 141, 0.7);
      font-size: 10pt;
    }

    .entry-meta {
      font-size: 10pt;
      color: rgba(141, 139, 141, 0.6);
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .edit-btn {
      padding: 5px 14px;
      background: rgba(229, 228, 233, 0.8);
      color: #8d8b8d;
      border: none;
      border-radius: 10px;
      font-size: 9pt;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.3px;
    }

    .edit-btn:hover {
      background: rgba(141, 139, 141, 0.25);
      color: #5b5c5e;
      transform: scale(1.08);
    }

    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-top: 32px;
    }

    .pagination-btn {
      padding: 10px 24px;
      background: rgba(229, 228, 233, 0.8);
      border: none;
      border-radius: 20px;
      font-size: 11pt;
      color: #8d8b8d;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.3px;
      font-weight: 500;
      box-shadow: 0 2px 12px rgba(141, 139, 141, 0.08);
    }

    .pagination-btn:hover:not(:disabled) {
      background: rgba(220, 220, 221, 0.95);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(141, 139, 141, 0.15);
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .pagination-info {
      font-size: 11pt;
      color: #8d8b8d;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(141, 139, 141, 0.4);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: rgba(229, 228, 233, 0.95);
      backdrop-filter: blur(20px);
      border: none;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: auto;
      animation: modalAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 20px 60px rgba(141, 139, 141, 0.3);
    }

    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      font-size: 16pt;
      font-weight: 600;
      margin-bottom: 24px;
      color: #8d8b8d;
      letter-spacing: -0.5px;
    }

    .modal-textarea {
      width: 100%;
      min-height: 150px;
      padding: 16px;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.7);
      font-size: 12pt;
      color: #8d8b8d;
      font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
      resize: vertical;
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 8px rgba(141, 139, 141, 0.06);
    }

    .modal-textarea:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: inset 0 2px 12px rgba(141, 139, 141, 0.1),
                  0 0 0 2px rgba(141, 139, 141, 0.15);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 12px 28px;
      border: none;
      border-radius: 20px;
      font-size: 11pt;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.3px;
      box-shadow: 0 2px 12px rgba(141, 139, 141, 0.08);
    }

    .modal-btn-primary {
      background: rgba(141, 139, 141, 0.25);
      color: #5b5c5e;
    }

    .modal-btn-primary:hover {
      background: rgba(141, 139, 141, 0.35);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(141, 139, 141, 0.2);
    }

    .modal-btn-secondary {
      background: rgba(229, 228, 233, 0.8);
      color: #8d8b8d;
    }

    .modal-btn-secondary:hover {
      background: rgba(220, 220, 221, 0.95);
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(141, 139, 141, 0.15);
    }

    /* Change Password Modal Specific Styles */
    .password-form-group {
      margin-bottom: 24px;
    }

    .password-form-label {
      display: block;
      font-size: 11pt;
      color: #8d8b8d;
      margin-bottom: 8px;
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    .password-form-input {
      width: 100%;
      padding: 14px 16px;
      font-size: 13pt;
      border: none;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.7);
      color: #8d8b8d;
      transition: all 0.3s ease;
      font-family: inherit;
      box-shadow: inset 0 2px 8px rgba(141, 139, 141, 0.06);
    }

    .password-form-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: inset 0 2px 12px rgba(141, 139, 141, 0.1),
                  0 0 0 2px rgba(141, 139, 141, 0.15);
    }

    .success-message {
      background: rgba(141, 139, 141, 0.15);
      border: none;
      border-radius: 12px;
      color: #5b5c5e;
      padding: 16px 20px;
      margin-bottom: 20px;
      font-size: 12pt;
      font-weight: normal;
      display: none;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 12px rgba(141, 139, 141, 0.1);
    }

    .success-message.show {
      display: flex;
      animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .success-message::before {
      content: '';
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%235b5c5e" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>') center/contain no-repeat;
    }

    .error-message-dashboard {
      background: rgba(141, 139, 141, 0.15);
      border: none;
      border-radius: 12px;
      color: #5b5c5e;
      padding: 16px 20px;
      margin-bottom: 20px;
      font-size: 12pt;
      font-weight: normal;
      display: none;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 12px rgba(141, 139, 141, 0.1);
    }

    .error-message-dashboard.show {
      display: flex;
      animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .error-message-dashboard::before {
      content: '';
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%235b5c5e" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>') center/contain no-repeat;
    }

    .loading-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 300px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(141, 139, 141, 0.6);
      font-size: 14pt;
    }

    .empty-icon {
      width: 60px;
      height: 60px;
      margin: 0 auto 16px;
      opacity: 0.3;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%238d8b8d" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 15h6"/></svg>') center/contain no-repeat;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1 class="dashboard-title">Admin Dashboard</h1>
      <div class="dashboard-actions">
        <span class="user-info">Welcome, <strong id="username">Admin</strong></span>
        <button class="header-btn change-password-btn" id="changePasswordBtn">Change Password</button>
        <button class="header-btn logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="dashboard-content">
      <div class="stats-bar" id="statsBar">
        <div class="stat-card">
          <div class="stat-value" id="totalGroups">-</div>
          <div class="stat-label">Total Groups</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="completedGroups">-</div>
          <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalEntries">-</div>
          <div class="stat-label">Total Entries</div>
        </div>
      </div>

      <div class="groups-section">
        <div class="section-header">
          <h2 class="section-title">All Groups</h2>
          <button class="refresh-btn" id="refreshBtn">↻ Refresh</button>
        </div>

        <div id="groupsList">
          <div class="loading-container">
            <div class="loading"></div>
          </div>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
          <button class="pagination-btn" id="prevBtn">← Previous</button>
          <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
          <button class="pagination-btn" id="nextBtn">Next →</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">Edit Entry</div>
      <textarea class="modal-textarea" id="editTextarea" placeholder="Enter text content..."></textarea>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-secondary" id="cancelEditBtn">Cancel</button>
        <button class="modal-btn modal-btn-primary" id="saveEditBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal" id="changePasswordModal">
    <div class="modal-content">
      <div class="modal-header">Change Password</div>
      
      <div class="success-message" id="passwordSuccessMessage"></div>
      <div class="error-message-dashboard" id="passwordErrorMessage"></div>

      <form id="changePasswordForm">
        <div class="password-form-group">
          <label class="password-form-label" for="currentPassword">Current Password</label>
          <input 
            type="password" 
            id="currentPassword" 
            class="password-form-input" 
            placeholder="Enter current password"
            required
          >
        </div>

        <div class="password-form-group">
          <label class="password-form-label" for="newPassword">New Password</label>
          <input 
            type="password" 
            id="newPassword" 
            class="password-form-input" 
            placeholder="Enter new password (min 6 characters)"
            required
            minlength="6"
          >
        </div>

        <div class="password-form-group">
          <label class="password-form-label" for="confirmPassword">Confirm New Password</label>
          <input 
            type="password" 
            id="confirmPassword" 
            class="password-form-input" 
            placeholder="Confirm new password"
            required
            minlength="6"
          >
        </div>

        <div class="modal-actions">
          <button type="button" class="modal-btn modal-btn-secondary" id="cancelPasswordBtn">Cancel</button>
          <button type="submit" class="modal-btn modal-btn-primary" id="savePasswordBtn">Change Password</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentPage = 1;
    const limit = 20;
    let totalPages = 1;
    let currentEditEntryId = null;

    // Check authentication
    async function checkAuth() {
      try {
        const response = await fetch('/admin/check-auth', { credentials: 'include' });
        const data = await response.json();
        
        if (!data.authenticated) {
          window.location.href = '/admin-login';
        } else {
          document.getElementById('username').textContent = data.username || 'Admin';
        }
      } catch (error) {
        console.error('Auth check error:', error);
        window.location.href = '/admin-login';
      }
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch('/admin/logout', {
          method: 'POST',
          credentials: 'include'
        });
        window.location.href = '/admin-login';
      } catch (error) {
        console.error('Logout error:', error);
      }
    });

    // Load groups
    async function loadGroups(page) {
      try {
        const groupsList = document.getElementById('groupsList');
        groupsList.innerHTML = '<div class="loading-container"><div class="loading"></div></div>';

        const response = await fetch(`/admin/groups?page=${page}&limit=${limit}`, {
          credentials: 'include'
        });
        const data = await response.json();

        if (data.success) {
          currentPage = page;
          totalPages = data.pagination.totalPages;

          // Update stats
          updateStats(data.groups);

          // Render groups
          if (data.groups.length === 0) {
            groupsList.innerHTML = `
              <div class="empty-state">
                <div class="empty-icon"></div>
                <div>No groups yet</div>
              </div>
            `;
            document.getElementById('pagination').style.display = 'none';
            return;
          }

          groupsList.innerHTML = '';
          data.groups.forEach(group => {
            const groupElement = createGroupElement(group);
            groupsList.appendChild(groupElement);
          });

          // Update pagination
          document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
          document.getElementById('prevBtn').disabled = currentPage <= 1;
          document.getElementById('nextBtn').disabled = currentPage >= totalPages;
          document.getElementById('pagination').style.display = 'flex';
        }
      } catch (error) {
        console.error('Error loading groups:', error);
        document.getElementById('groupsList').innerHTML = '<div class="empty-state"><div>Failed to load groups</div></div>';
      }
    }

    function updateStats(groups) {
      const totalGroups = groups.length;
      const completedGroups = groups.filter(g => g.is_completed).length;
      const totalEntries = groups.reduce((sum, g) => sum + g.entries.length, 0);

      document.getElementById('totalGroups').textContent = totalGroups;
      document.getElementById('completedGroups').textContent = completedGroups;
      document.getElementById('totalEntries').textContent = totalEntries;
    }

    function createGroupElement(group) {
      const div = document.createElement('div');
      div.className = 'group-item';

      const statusClass = group.is_completed ? 'complete' : 'incomplete';
      const statusText = group.is_completed ? 'Complete' : `${group.entries.length}/5`;

      let entriesHTML = '';
      group.entries.forEach(entry => {
        const time = new Date(entry.created_at).toLocaleString();
        entriesHTML += `
          <tr>
            <td>${entry.position_in_group}</td>
            <td class="entry-text">${escapeHtml(entry.text_content)}</td>
            <td class="entry-solfege">${entry.solfege || '-'}</td>
            <td class="entry-meta" title="${entry.ip_address}">${entry.ip_address || '-'}</td>
            <td class="entry-meta" title="${entry.user_agent}">${truncate(entry.user_agent, 20)}</td>
            <td>${time}</td>
            <td><button class="edit-btn" onclick="openEditModal(${entry.id}, '${escapeHtml(entry.text_content).replace(/'/g, "\\'")}')">Edit</button></td>
          </tr>
        `;
      });

      div.innerHTML = `
        <div class="group-item-header" onclick="toggleGroup(this)">
          <div class="group-item-info">
            <span class="group-number">Group ${group.group_number}</span>
            <span class="group-badge ${statusClass}">${statusText}</span>
            <span style="font-size: 11pt; color: #999;">${group.entries.length} entries</span>
          </div>
          <div class="group-item-actions" onclick="event.stopPropagation()">
            <button class="delete-group-btn" onclick="deleteGroup(${group.id}, ${group.group_number})">Delete Group</button>
            <span class="expand-icon">▼</span>
          </div>
        </div>
        <div class="group-item-body">
          <table class="entries-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Text Content</th>
                <th>Solfege</th>
                <th>IP Address</th>
                <th>User Agent</th>
                <th>Created At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${entriesHTML}
            </tbody>
          </table>
        </div>
      `;

      return div;
    }

    function toggleGroup(header) {
      const body = header.nextElementSibling;
      const icon = header.querySelector('.expand-icon');
      
      body.classList.toggle('expanded');
      icon.classList.toggle('expanded');
    }

    async function deleteGroup(groupId, groupNumber) {
      if (!confirm(`Are you sure you want to delete Group ${groupNumber}? This action cannot be undone!`)) {
        return;
      }

      try {
        const response = await fetch(`/admin/group/${groupId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const data = await response.json();

        if (data.success) {
          alert('Group deleted successfully');
          loadGroups(currentPage);
        } else {
          alert(data.message || 'Failed to delete group');
        }
      } catch (error) {
        console.error('Error deleting group:', error);
        alert('Failed to delete group');
      }
    }

    function openEditModal(entryId, text) {
      currentEditEntryId = entryId;
      document.getElementById('editTextarea').value = text;
      document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      currentEditEntryId = null;
    }

    document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);

    document.getElementById('saveEditBtn').addEventListener('click', async () => {
      const newText = document.getElementById('editTextarea').value.trim();
      
      if (!newText) {
        alert('Text content cannot be empty');
        return;
      }

      try {
        const response = await fetch(`/admin/entry/${currentEditEntryId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ textContent: newText })
        });
        const data = await response.json();

        if (data.success) {
          alert('Entry updated successfully');
          closeEditModal();
          loadGroups(currentPage);
        } else {
          alert(data.message || 'Failed to update entry');
        }
      } catch (error) {
        console.error('Error updating entry:', error);
        alert('Failed to update entry');
      }
    });

    // Close modal on outside click
    document.getElementById('editModal').addEventListener('click', (e) => {
      if (e.target.id === 'editModal') {
        closeEditModal();
      }
    });

    // Pagination
    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentPage > 1) loadGroups(currentPage - 1);
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentPage < totalPages) loadGroups(currentPage + 1);
    });

    document.getElementById('refreshBtn').addEventListener('click', () => {
      loadGroups(currentPage);
    });

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function truncate(str, len) {
      if (!str) return '-';
      return str.length > len ? str.substring(0, len) + '...' : str;
    }

    // Change Password functionality
    document.getElementById('changePasswordBtn').addEventListener('click', () => {
      document.getElementById('changePasswordModal').classList.add('show');
      document.getElementById('changePasswordForm').reset();
      document.getElementById('passwordSuccessMessage').classList.remove('show');
      document.getElementById('passwordErrorMessage').classList.remove('show');
    });

    document.getElementById('cancelPasswordBtn').addEventListener('click', () => {
      document.getElementById('changePasswordModal').classList.remove('show');
    });

    // Close modal on outside click
    document.getElementById('changePasswordModal').addEventListener('click', (e) => {
      if (e.target.id === 'changePasswordModal') {
        document.getElementById('changePasswordModal').classList.remove('show');
      }
    });

    function showPasswordMessage(message, isError = false) {
      const successMsg = document.getElementById('passwordSuccessMessage');
      const errorMsg = document.getElementById('passwordErrorMessage');
      
      if (isError) {
        errorMsg.textContent = message.replace('⚠️ ', '');
        errorMsg.classList.add('show');
        successMsg.classList.remove('show');
      } else {
        successMsg.textContent = message.replace('✓ ', '');
        successMsg.classList.add('show');
        errorMsg.classList.remove('show');
      }
      
      setTimeout(() => {
        successMsg.classList.remove('show');
        errorMsg.classList.remove('show');
      }, 5000);
    }

    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Client-side validation
      if (newPassword !== confirmPassword) {
        showPasswordMessage('New passwords do not match', true);
        return;
      }

      if (newPassword.length < 6) {
        showPasswordMessage('New password must be at least 6 characters', true);
        return;
      }

      if (newPassword === currentPassword) {
        showPasswordMessage('New password must be different from current password', true);
        return;
      }

      const saveBtn = document.getElementById('savePasswordBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Changing...';

      try {
        const response = await fetch('/admin/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({
            currentPassword,
            newPassword,
            confirmPassword
          })
        });

        const data = await response.json();

        if (data.success) {
          showPasswordMessage('Password changed successfully!', false);
          document.getElementById('changePasswordForm').reset();
          
          // Close modal after 2 seconds
          setTimeout(() => {
            document.getElementById('changePasswordModal').classList.remove('show');
          }, 2000);
        } else {
          showPasswordMessage(data.message || 'Failed to change password', true);
        }
      } catch (error) {
        console.error('Error changing password:', error);
        showPasswordMessage('Network error. Please try again.', true);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Change Password';
      }
    });

    // Initialize
    checkAuth();
    loadGroups(1);
  </script>
</body>
</html>

